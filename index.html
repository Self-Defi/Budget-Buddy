<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Household Financial Operating Plan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    }

    body {
      margin: 0;
      padding: 16px;
      background: #f5f6fa;
      color: #222;
    }

    h1 {
      text-align: center;
      margin-bottom: 4px;
    }

    h2 {
      margin-top: 0;
      margin-bottom: 8px;
    }

    p {
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .page-subtitle {
      text-align: center;
      margin-bottom: 24px;
      color: #555;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
      max-width: 1200px;
      margin: 0 auto 32px auto;
    }

    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 16px 18px 18px 18px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
      border: 1px solid #e0e4f0;
    }

    .card h2 {
      font-size: 18px;
    }

    .section-tag {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
      background: #e8f1ff;
      color: #194786;
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: #555;
    }

    input[type="number"],
    input[type="date"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #cbd2e3;
      font-size: 14px;
    }

    input[type="number"]:focus,
    input[type="date"]:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.15);
    }

    .value-highlight {
      font-weight: 700;
      color: #0f766e;
    }

    ul {
      padding-left: 20px;
      margin-top: 8px;
      margin-bottom: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 8px;
    }

    th,
    td {
      border: 1px solid #e0e4f0;
      padding: 6px 8px;
      text-align: left;
    }

    th {
      background: #eff3ff;
      font-weight: 600;
    }

    .footer-note {
      font-size: 12px;
      color: #666;
      margin-top: 6px;
    }

    .pill-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      border: none;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: #1d4ed8;
      color: #fff;
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.25);
    }

    .pill-button:active {
      transform: translateY(1px);
      box-shadow: 0 6px 14px rgba(37, 99, 235, 0.25);
    }

    .refresh-container {
      max-width: 1200px;
      margin: 0 auto 24px auto;
      display: flex;
      justify-content: flex-end;
    }

    .pill-button svg {
      margin-right: 6px;
    }

    .status-paid {
      background: #dcfce7;
    }

    .status-due-soon {
      background: #fef9c3;
    }

    .status-overdue {
      background: #fee2e2;
    }

    .status-none {
      background: #f9fafb;
    }

    @media (max-width: 768px) {
      body {
        padding: 12px;
      }

      .grid {
        gap: 12px;
      }

      .card {
        padding: 14px 14px 16px 14px;
      }
    }
  </style>
</head>
<body>
  <h1>Household Financial Operating Plan</h1>
  <p class="page-subtitle">Interactive 24-Month Roadmap — All values editable</p>

  <!-- Refresh Plan -->
  <div class="refresh-container">
    <button class="pill-button" id="refreshPlanBtn">
      <svg width="16" height="16" viewBox="0 0 20 20" fill="none">
        <path d="M4 4v4h4" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M16 16v-4h-4" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M4.5 11a5 5 0 0 0 8.5 3.5L16 12" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M15.5 9A5 5 0 0 0 7 5.5L4 8" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Refresh Plan
    </button>
  </div>

  <!-- Top grid: Income / Free Cash / HOE / External contribution -->
  <div class="grid">
    <!-- Income Engine -->
    <div class="card">
      <div class="section-tag">Income Engine</div>
      <h2>Monthly Income</h2>
      <label for="monthlyIncome">Monthly planning base</label>
      <input id="monthlyIncome" type="number" min="0" step="50" value="9500" />
      <p class="footer-note">
        This is the total income per month that funds all household operating expenses and allocations.
      </p>
    </div>

    <!-- Free Cash -->
    <div class="card">
      <div class="section-tag">Liquidity</div>
      <h2>Free Cash Flow (Calculated)</h2>
      <p>Free Cash Flow per month:
        <span class="value-highlight" id="freeCashDisplay">$384</span>
      </p>
      <ul>
        <li>Calculated as income minus all household operating expenses (including reserves and investment).</li>
        <li>Used for opportunities, shocks, or targeted extra debt paydown.</li>
      </ul>
    </div>

    <!-- HOE -->
    <div class="card">
      <div class="section-tag">Core Structure</div>
      <h2>Household Operating Expenses<br />(funded by monthly income)</h2>

      <label for="mortgage">Mortgage</label>
      <input id="mortgage" type="number" min="0" step="50" value="3500" />

      <label for="autoLoans">Auto Loans (total)</label>
      <input id="autoLoans" type="number" min="0" step="50" value="1290" />

      <label for="householdInsurance">Household Insurance</label>
      <input id="householdInsurance" type="number" min="0" step="25" value="1000" />

      <label for="utilities">Utilities</label>
      <input id="utilities" type="number" min="0" step="25" value="400" />

      <label for="settlementProgram">Settlement Program</label>
      <input id="settlementProgram" type="number" min="0" step="10" value="276" />

      <label for="chaseRepayment">Chase Bank Repayment</label>
      <input id="chaseRepayment" type="number" min="0" step="10" value="150" />

      <label for="parentCCRepayment">Parent Credit Card Repayment</label>
      <input id="parentCCRepayment" type="number" min="0" step="25" value="500" />

      <label for="groceries">Groceries</label>
      <input id="groceries" type="number" min="0" step="25" value="650" />

      <label for="fuel">Fuel</label>
      <input id="fuel" type="number" min="0" step="25" value="300" />

      <label for="parentReward">Parent Reward System</label>
      <input id="parentReward" type="number" min="0" step="25" value="400" />

      <label for="emergencyReserve">Emergency Operating Reserve</label>
      <input id="emergencyReserve" type="number" min="0" step="25" value="200" />

      <label for="investmentDeposit">Investment Account Deposit</label>
      <input id="investmentDeposit" type="number" min="0" step="25" value="450" />

      <p style="margin-top:8px;">
        Total Household Operating Expenses:
        <span class="value-highlight" id="totalHOEDisplay">$9,116 per month</span>
      </p>
    </div>

    <!-- External principal reduction -->
    <div class="card">
      <div class="section-tag">Debt Acceleration</div>
      <h2>External Principal Reduction</h2>

      <label for="kidsContribution">Kids CC Contribution (external)</label>
      <input id="kidsContribution" type="number" min="0" step="10" value="200" />

      <p class="footer-note">
        Kids’ contribution is not funded from monthly income. It goes directly to credit card principal.
      </p>

      <p style="margin-top:8px;">
        Total Credit Card principal reduction per month<br />
        (parents + kids):
        <span class="value-highlight" id="totalCCReductionDisplay">$700</span>
      </p>
    </div>
  </div>

  <!-- Paycheck routing -->
  <div class="grid">
    <div class="card">
      <div class="section-tag">Bi-Weekly Routing</div>
      <h2>Paycheck 1 Routing (Reference)</h2>
      <ul>
        <li>Mortgage — <span id="p1-mortgage">$3,500</span></li>
        <li>Groceries — <span id="p1-groceries">$300</span></li>
        <li>Fuel — <span id="p1-fuel">$150</span></li>
        <li>Parent Reward — <span id="p1-parentReward">$200</span></li>
        <li>Parent CC Repayment — <span id="p1-parentCC">$250</span></li>
        <li>Investment — <span id="p1-investment">$225</span></li>
        <li>Emergency Reserve — <span id="p1-emergency">$100</span></li>
        <li>Free Cash — <span id="p1-freeCash">$25</span></li>
      </ul>
      <p class="footer-note">
        Reference values based on the default plan. If you change the inputs above, use this as a guide and adjust manually.
      </p>
    </div>

    <div class="card">
      <div class="section-tag">Bi-Weekly Routing</div>
      <h2>Paycheck 2 Routing (Reference)</h2>
      <ul>
        <li>Auto Loans — <span id="p2-auto">$1,290</span></li>
        <li>Household Insurance — <span id="p2-insurance">$1,000</span></li>
        <li>Utilities — <span id="p2-utilities">$400</span></li>
        <li>Settlement — <span id="p2-settlement">$276</span></li>
        <li>Chase — <span id="p2-chase">$150</span></li>
        <li>Groceries — <span id="p2-groceries">$350</span></li>
        <li>Fuel — <span id="p2-fuel">$150</span></li>
        <li>Parent Reward — <span id="p2-parentReward">$200</span></li>
        <li>Parent CC Repayment — <span id="p2-parentCC">$250</span></li>
        <li>Investment — <span id="p2-investment">$225</span></li>
        <li>Emergency Reserve — <span id="p2-emergency">$100</span></li>
        <li>Free Cash — <span id="p2-freeCash">$359</span></li>
      </ul>
      <p class="footer-note">
        Paycheck 2 clears the remaining fixed obligations and leaves the bulk of monthly free cash.
      </p>
    </div>
  </div>

  <!-- Projections -->
  <div class="grid">
    <div class="card">
      <div class="section-tag">Projection – 24 Months</div>
      <h2>Quarterly Projections (2-Year Plan)</h2>
      <p class="footer-note">
        All values below update automatically when you change numbers in the inputs above.
      </p>
      <table>
        <thead>
          <tr>
            <th>Quarter</th>
            <th>Free Cash (3 mo)</th>
            <th>Investment (3 mo)</th>
            <th>Parent Reward (3 mo)</th>
            <th>CC Reduction (3 mo)</th>
          </tr>
        </thead>
        <tbody id="quarterlyTableBody"></tbody>
      </table>
    </div>

    <div class="card">
      <div class="section-tag">Cumulative View</div>
      <h2>Cumulative Performance Over 2 Years</h2>
      <table>
        <thead>
          <tr>
            <th>Quarter</th>
            <th>Cumulative Free Cash</th>
            <th>Cumulative Investment</th>
            <th>Cumulative Parent Reward</th>
            <th>Cumulative CC Reduction</th>
          </tr>
        </thead>
        <tbody id="cumulativeTableBody"></tbody>
      </table>
      <p style="margin-top:8px;">
        Net position improvement after 24 months (Free Cash + Investment Funding + Debt Eliminated):
        <span class="value-highlight" id="netPositionDisplay">$36,816</span>
      </p>
    </div>
  </div>

  <!-- Bill Tracking + Notes -->
  <div class="grid">
    <div class="card">
      <div class="section-tag">Bill Tracking</div>
      <h2>Bill Due Dates &amp; Payment Status</h2>
      <p class="footer-note">
        Due dates and “Paid this month” status are stored in your browser only and reset automatically each month.
      </p>
      <table>
        <thead>
          <tr>
            <th>Bill</th>
            <th>Amount (current)</th>
            <th>Due Date</th>
            <th>Status</th>
            <th>Paid this month</th>
          </tr>
        </thead>
        <tbody id="billTableBody">
          <!-- rows injected by JS so they stay in sync with HOE amounts -->
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="section-tag">Governance Notes</div>
      <h2>Executive Notes</h2>
      <ul>
        <li>Household remains structurally oriented toward solvency if income and expenses stay within planned ranges.</li>
        <li>Every critical obligation is funded before Free Cash Flow is counted.</li>
        <li>Total credit card principal reduced each month is parents’ repayment plus kids’ contribution.</li>
        <li>Parent Reward System is intentional: it maintains long-term discipline and cooperation.</li>
        <li>When credit card debt is fully repaid, that monthly amount can be reallocated to reserves, investments, or other growth strategies.</li>
      </ul>
      <p class="footer-note">
        Adjust any input above to immediately see the impact on monthly Free Cash Flow, quarterly performance, and 24-month cumulative results.
      </p>
    </div>
  </div>

  <script>
    const PLAN_STORAGE_KEY = 'budgetBuddy-plan-v1';
    const BILL_STORAGE_PREFIX = 'budgetBuddy-bills-';

    function formatCurrency(value) {
      const n = Number(value) || 0;
      return n.toLocaleString('en-US', {
        style: 'currency',
        currency: 'USD',
        maximumFractionDigits: 0
      });
    }

    function getNumeric(id) {
      const el = document.getElementById(id);
      return el ? Number(el.value || 0) : 0;
    }

    function setText(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = typeof value === 'string' ? value : formatCurrency(value);
    }

    function quarterKey() {
      const d = new Date();
      const ym = d.getFullYear().toString() + String(d.getMonth() + 1).padStart(2, '0');
      return BILL_STORAGE_PREFIX + ym;
    }

    function updateCalculations() {
      const monthlyIncome = getNumeric('monthlyIncome');

      const mortgage = getNumeric('mortgage');
      const auto = getNumeric('autoLoans');
      const insurance = getNumeric('householdInsurance');
      const utilities = getNumeric('utilities');
      const settlement = getNumeric('settlementProgram');
      const chase = getNumeric('chaseRepayment');
      const parentCC = getNumeric('parentCCRepayment');
      const groceries = getNumeric('groceries');
      const fuel = getNumeric('fuel');
      const parentReward = getNumeric('parentReward');
      const emergency = getNumeric('emergencyReserve');
      const investment = getNumeric('investmentDeposit');

      const kidsContribution = getNumeric('kidsContribution');

      const totalHOE =
        mortgage + auto + insurance + utilities + settlement + chase +
        parentCC + groceries + fuel + parentReward + emergency + investment;

      const freeCash = monthlyIncome - totalHOE;

      setText('totalHOEDisplay', `${formatCurrency(totalHOE)} per month`);
      setText('freeCashDisplay', formatCurrency(freeCash));

      const totalCCReduction = parentCC + kidsContribution;
      setText('totalCCReductionDisplay', totalCCReduction);

      // === Routing logic ===
      const paycheckIncome = monthlyIncome / 2;

      // Split items between Paycheck 1 and Paycheck 2.
      // Mortgage: 100% Paycheck 1
      const p1Mortgage = mortgage;

      // Auto + Insurance + Utilities + Settlement + Chase: Paycheck 2
      const p2Auto = auto;
      const p2Insurance = insurance;
      const p2Utilities = utilities;
      const p2Settlement = settlement;
      const p2Chase = chase;

      // Parent CC: 50/50 split, rounding on Paycheck 1
      const p1ParentCC = Math.round(parentCC / 2);
      const p2ParentCC = parentCC - p1ParentCC;

      // Groceries: preserve original feel (approx 300 / 350 split for 650)
      const groceriesRatioP1 = 300 / 650; // base ratio, applied to any groceries number
      const p1Groceries = Math.round(groceries * groceriesRatioP1);
      const p2Groceries = groceries - p1Groceries;

      // Fuel: simple 50/50 split
      const p1Fuel = Math.round(fuel / 2);
      const p2Fuel = fuel - p1Fuel;

      // Parent Reward, Emergency, Investment: 50/50 split
      const p1ParentReward = Math.round(parentReward / 2);
      const p2ParentReward = parentReward - p1ParentReward;

      const p1Emergency = Math.round(emergency / 2);
      const p2Emergency = emergency - p1Emergency;

      const p1Investment = Math.round(investment / 2);
      const p2Investment = investment - p1Investment;

      // Totals per paycheck
      const p1HOE =
        p1Mortgage +
        p1Groceries +
        p1Fuel +
        p1ParentReward +
        p1ParentCC +
        p1Investment +
        p1Emergency;

      const p2HOE =
        p2Auto +
        p2Insurance +
        p2Utilities +
        p2Settlement +
        p2Chase +
        p2Groceries +
        p2Fuel +
        p2ParentReward +
        p2ParentCC +
        p2Investment +
        p2Emergency;

      const p1Free = paycheckIncome - p1HOE;
      const p2Free = paycheckIncome - p2HOE;

      // Sanity: p1HOE + p2HOE should equal totalHOE; the design guarantees this.
      // Update routing display
      setText('p1-mortgage', p1Mortgage);
      setText('p1-groceries', p1Groceries);
      setText('p1-fuel', p1Fuel);
      setText('p1-parentReward', p1ParentReward);
      setText('p1-parentCC', p1ParentCC);
      setText('p1-investment', p1Investment);
      setText('p1-emergency', p1Emergency);
      setText('p1-freeCash', p1Free);

      setText('p2-auto', p2Auto);
      setText('p2-insurance', p2Insurance);
      setText('p2-utilities', p2Utilities);
      setText('p2-settlement', p2Settlement);
      setText('p2-chase', p2Chase);
      setText('p2-groceries', p2Groceries);
      setText('p2-fuel', p2Fuel);
      setText('p2-parentReward', p2ParentReward);
      setText('p2-parentCC', p2ParentCC);
      setText('p2-investment', p2Investment);
      setText('p2-emergency', p2Emergency);
      setText('p2-freeCash', p2Free);

      // === Quarterly projections ===
      const qFree = freeCash * 3;
      const qInvest = investment * 3;
      const qParentReward = parentReward * 3;
      const qCCReduction = totalCCReduction * 3;

      const quarterlyBody = document.getElementById('quarterlyTableBody');
      const cumulativeBody = document.getElementById('cumulativeTableBody');
      if (!quarterlyBody || !cumulativeBody) return;

      quarterlyBody.innerHTML = '';
      cumulativeBody.innerHTML = '';

      let cumFree = 0;
      let cumInvest = 0;
      let cumReward = 0;
      let cumCC = 0;

      for (let i = 1; i <= 8; i++) {
        const qLabel = 'Q' + i;

        cumFree += qFree;
        cumInvest += qInvest;
        cumReward += qParentReward;
        cumCC += qCCReduction;

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${qLabel}</td>
          <td>${formatCurrency(qFree)}</td>
          <td>${formatCurrency(qInvest)}</td>
          <td>${formatCurrency(qParentReward)}</td>
          <td>${formatCurrency(qCCReduction)}</td>
        `;
        quarterlyBody.appendChild(row);

        const crow = document.createElement('tr');
        crow.innerHTML = `
          <td>${qLabel}</td>
          <td>${formatCurrency(cumFree)}</td>
          <td>${formatCurrency(cumInvest)}</td>
          <td>${formatCurrency(cumReward)}</td>
          <td>${formatCurrency(cumCC)}</td>
        `;
        cumulativeBody.appendChild(crow);
      }

      const netPosition = cumFree + cumInvest + cumCC;
      setText('netPositionDisplay', netPosition);

      updateBillAmounts({
        mortgage,
        auto,
        insurance,
        utilities,
        settlement,
        chase,
        parentCC,
        groceries,
        fuel,
        parentReward,
        emergency,
        investment
      });

      savePlanToStorage();
    }

    // === Bill tracking ===
    const BILL_CONFIG = [
      { id: 'bill-mortgage', label: 'Mortgage', amountId: 'mortgage' },
      { id: 'bill-auto', label: 'Auto Loans (total)', amountId: 'autoLoans' },
      { id: 'bill-insurance', label: 'Household Insurance', amountId: 'householdInsurance' },
      { id: 'bill-utilities', label: 'Utilities', amountId: 'utilities' },
      { id: 'bill-settlement', label: 'Settlement Program', amountId: 'settlementProgram' },
      { id: 'bill-chase', label: 'Chase Bank Repayment', amountId: 'chaseRepayment' },
      { id: 'bill-parentCC', label: 'Parent Credit Card Repayment', amountId: 'parentCCRepayment' },
      { id: 'bill-groceries', label: 'Groceries', amountId: 'groceries' },
      { id: 'bill-fuel', label: 'Fuel', amountId: 'fuel' },
      { id: 'bill-parentReward', label: 'Parent Reward System', amountId: 'parentReward' },
      { id: 'bill-emergency', label: 'Emergency Operating Reserve', amountId: 'emergencyReserve' },
      { id: 'bill-investment', label: 'Investment Account Deposit', amountId: 'investmentDeposit' }
    ];

    function buildBillTable() {
      const tbody = document.getElementById('billTableBody');
      if (!tbody) return;
      tbody.innerHTML = '';

      const stored = loadBillState();

      BILL_CONFIG.forEach(cfg => {
        const tr = document.createElement('tr');
        const amount = getNumeric(cfg.amountId);

        const saved = stored[cfg.id] || {};
        const dueDateValue = saved.dueDate || '';
        const paid = !!saved.paid;

        tr.innerHTML = `
          <td>${cfg.label}</td>
          <td><span class="bill-amount" data-amount-id="${cfg.amountId}">${formatCurrency(amount)}</span></td>
          <td><input type="date" class="bill-due" data-bill-id="${cfg.id}" value="${dueDateValue}"></td>
          <td><span class="bill-status" data-bill-id="${cfg.id}"></span></td>
          <td style="text-align:center;"><input type="checkbox" class="bill-paid" data-bill-id="${cfg.id}" ${paid ? 'checked' : ''}></td>
        `;
        tbody.appendChild(tr);
      });

      attachBillHandlers();
      refreshBillStatuses();
    }

    function updateBillAmounts(values) {
      BILL_CONFIG.forEach(cfg => {
        const span = document.querySelector(`span.bill-amount[data-amount-id="${cfg.amountId}"]`);
        if (span) {
          const v = values[cfg.amountId.replace('Program', '').replace('Repayment', '')] || getNumeric(cfg.amountId);
          span.textContent = formatCurrency(getNumeric(cfg.amountId));
        }
      });
      refreshBillStatuses();
    }

    function attachBillHandlers() {
      const dueInputs = document.querySelectorAll('.bill-due');
      const paidChecks = document.querySelectorAll('.bill-paid');

      dueInputs.forEach(input => {
        input.addEventListener('change', () => {
          saveBillState();
          refreshBillStatuses();
        });
      });

      paidChecks.forEach(chk => {
        chk.addEventListener('change', () => {
          saveBillState();
          refreshBillStatuses();
        });
      });
    }

    function loadBillState() {
      const key = quarterKey();
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return {};
        return JSON.parse(raw) || {};
      } catch {
        return {};
      }
    }

    function saveBillState() {
      const key = quarterKey();
      const state = {};
      const dueInputs = document.querySelectorAll('.bill-due');
      const paidChecks = document.querySelectorAll('.bill-paid');

      dueInputs.forEach(input => {
        const id = input.getAttribute('data-bill-id');
        if (!state[id]) state[id] = {};
        state[id].dueDate = input.value || '';
      });

      paidChecks.forEach(chk => {
        const id = chk.getAttribute('data-bill-id');
        if (!state[id]) state[id] = {};
        state[id].paid = chk.checked;
      });

      localStorage.setItem(key, JSON.stringify(state));
    }

    function refreshBillStatuses() {
      const today = new Date();
      const todayISO = today.toISOString().slice(0, 10);
      const statusSpans = document.querySelectorAll('.bill-status');

      statusSpans.forEach(span => {
        const billId = span.getAttribute('data-bill-id');
        const row = span.closest('tr');
        if (!row) return;

        const dueInput = row.querySelector('.bill-due');
        const paidChk = row.querySelector('.bill-paid');

        const dueDate = dueInput ? dueInput.value : '';
        const paid = paidChk ? paidChk.checked : false;

        row.classList.remove('status-paid', 'status-due-soon', 'status-overdue', 'status-none');

        if (!dueDate) {
          span.textContent = 'No date set';
          row.classList.add('status-none');
        } else if (paid) {
          span.textContent = 'Paid this month';
          row.classList.add('status-paid');
        } else {
          const diffDays = (new Date(dueDate) - new Date(todayISO)) / (1000 * 60 * 60 * 24);
          if (diffDays < 0) {
            span.textContent = 'Overdue';
            row.classList.add('status-overdue');
          } else if (diffDays <= 7) {
            span.textContent = `Due in ${Math.round(diffDays)} day(s)`;
            row.classList.add('status-due-soon');
          } else {
            span.textContent = 'Scheduled';
            row.classList.add('status-none');
          }
        }
      });
    }

    // === Plan storage ===
    function savePlanToStorage() {
      const ids = [
        'monthlyIncome',
        'mortgage',
        'autoLoans',
        'householdInsurance',
        'utilities',
        'settlementProgram',
        'chaseRepayment',
        'parentCCRepayment',
        'groceries',
        'fuel',
        'parentReward',
        'emergencyReserve',
        'investmentDeposit',
        'kidsContribution'
      ];
      const data = {};
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) data[id] = el.value;
      });
      try {
        localStorage.setItem(PLAN_STORAGE_KEY, JSON.stringify(data));
      } catch {
        // ignore storage errors
      }
    }

    function loadPlanFromStorage() {
      try {
        const raw = localStorage.getItem(PLAN_STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        Object.keys(data).forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = data[id];
        });
      } catch {
        // ignore
      }
    }

    function resetPlan() {
      localStorage.removeItem(PLAN_STORAGE_KEY);
      // Clear this month’s bill tracking
      localStorage.removeItem(quarterKey());
      // Reload page to restore defaults
      location.reload();
    }

    // === Init ===
    document.addEventListener('DOMContentLoaded', () => {
      loadPlanFromStorage();
      buildBillTable();
      updateCalculations();

      const inputs = document.querySelectorAll('input[type="number"]');
      inputs.forEach(input => {
        input.addEventListener('input', updateCalculations);
      });

      document.getElementById('refreshPlanBtn').addEventListener('click', resetPlan);
    });
  </script>
</body>
</html>



